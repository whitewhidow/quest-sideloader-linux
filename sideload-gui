#!/bin/bash

case "$OSTYPE" in
linux*) OSTYPE="linux" ;;
darwin*) OSTYPE="mac" ;;
*) echo "unknown OS: $OSTYPE DETECTED" && echo "please submit a ticket om github?" && sleep 30 && exit ;;
esac

if [[ $(which sideload) != *"sideload"* ]]; then
  echo ''
  echo 'Please globally install the sideloader first from https://github.com/whitewhidow/quest-sideloader-linux'
  echo ''
  read -p "Press enter to close"
  exit 1
fi

#if [[ $(which sideload-update) == *"sideload-update"* ]] && [ "$RANDOM" -lt 15276 ] &&; then
#	zenity --question --width=800 --text="Would you like to check for updates? (and/or new mount config(s))"
#	if [ $? = 0 ]; then
#		exec sideload-update
#	fi
#fi

echo "Checking zenity installation."
if [ -z $CI ] && [[ $(which zenity 2>/dev/null) != *"zenity"* ]]; then
  echo "Installing zenity."
  (sudo apt install zenity >/dev/null 2>/dev/null || brew install zenity >/dev/null 2>/dev/null) && echo "zenity installed."
else
  echo "Zenity installation found."
fi

SELECTION=$HOME



while [ -z $CI ] && true; do


  VAR=$(ls )

  if [ `ls -1A . | wc -l` -eq 0 ]; then
    cd ..
    SELECTION=$PWD
  fi

  SELECTION=$(zenity --list --title="Current dir: $PWD" --text="Please select to an APK file to sideload." \
    --ok-label "Select" --cancel-label "Exit" \
    --width=800 --height=600 --column="Filename" "../" ${globby} "../" 2>/dev/null)
  CLEANFOLDER=$(echo "$SELECTION" | sed -e 's/\\/\\\\/g' -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')

  #sleep 10
  echo "SELECTED: $SELECTION\n\n"

  [[ "$SELECTION" == "../" ]] && cd ../ && continue
  [[ -z $SELECTION ]] && break
  [ $? -eq 0 ] && break



  if [[ "$SELECTION" == *".apk" ]]; then

    zenity --question --width=800 --text="Do you want to install the apk ($SELECTION) from the directory \"$PWD\" ?"
    if [ $? = 0 ]; then
      #echo '' > /tmp/sideload.log
      /usr/local/bin/sideload "$SELECTION" # | tee /tmp/sideload.log

      #RESULT=$(cat /tmp/sideload.log | sed -e 's/\\/\\\\/g' -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' | tr '' '\n' | tail -n +2)
      #zenity --info --width=800 --text="$(echo $RESULT| tr '' '\n' | tail -n +2)"
      ISSUETEXT="If any error has occured, please provide me with a copy of the terminal window response at \n<a href=\"https://github.com/whitewhidow/quest-sideloader-linux/issues\">https://github.com/whitewhidow/quest-sideloader-linux/issues</a>\nor find me at t.me/whitewhidow_q2_working\n\nAnd i will gladly assist you!"
      zenity --info --width=800 --text="<b><u>The sideloading process has finished, please inspect the output in the terminal!</u></b>\n\n$ISSUETEXT"
      echo -e "\nThe sideloading process has finished, please inspect the output above for any errors."
      echo -e "\n$ISSUETEXT"
      echo -e ''
      read -p "Press enter to sideload another app. or CTRL+C to close the sideloader."
      continue
    else
      echo -ne ''
    fi

  else
      cd "$SELECTION" 2>/dev/null && echo "cd to $SELECTION" || zenity --warning --width=800 --text="$SELECTION is not a valid APK or valid directory"

  fi
done

exit 0
